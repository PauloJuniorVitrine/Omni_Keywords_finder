# üóÑÔ∏è CONFIGURA√á√ÉO POSTGRESQL - OMNƒ∞ KEYWORDS FINDER
# üìÖ Criado: 2025-01-27
# üîß Tracing ID: CHECKLIST_99_PERCENT_20250127_001
# üéØ Objetivo: Configura√ß√£o enterprise-grade PostgreSQL

# =============================================================================
# üö® CONFIGURA√á√ÉO CR√çTICA DE BANCO DE DADOS
# =============================================================================

database:
  type: "postgresql"
  version: "15"  # Vers√£o m√≠nima recomendada
  environment: "production"
  cluster_mode: "primary_replica"  # ou "standalone", "cluster"
  connection_pool: "pgbouncer"
  backup_strategy: "continuous_archiving"

# =============================================================================
# üîó CONFIGURA√á√ïES DE CONEX√ÉO
# =============================================================================

connection:
  primary:
    host: "localhost"
    port: 5432
    database: "omni_keywords_production"
    username: "omni_user"
    password: "omni_secure_password_2025_ultra_encrypted"
    ssl_mode: "require"
    ssl_cert: "/etc/ssl/certs/postgresql-client.crt"
    ssl_key: "/etc/ssl/private/postgresql-client.key"
    ssl_ca: "/etc/ssl/certs/postgresql-ca.crt"
    
  replica:
    host: "replica.omni-keywords-finder.com"
    port: 5432
    database: "omni_keywords_production"
    username: "omni_readonly_user"
    password: "omni_readonly_password_2025_ultra_encrypted"
    ssl_mode: "require"
    
  connection_pool:
    min_connections: 5
    max_connections: 100
    connection_timeout: 30
    idle_timeout: 300
    max_lifetime: 3600

# =============================================================================
# ‚öôÔ∏è CONFIGURA√á√ïES DE PERFORMANCE
# =============================================================================

performance:
  # Configura√ß√µes de Mem√≥ria
  shared_buffers: "2GB"  # 25% da RAM total
  effective_cache_size: "8GB"  # 75% da RAM total
  work_mem: "64MB"  # Para opera√ß√µes de ordena√ß√£o
  maintenance_work_mem: "512MB"  # Para manuten√ß√£o
  
  # Configura√ß√µes de WAL (Write-Ahead Logging)
  wal_buffers: "16MB"
  checkpoint_completion_target: 0.9
  checkpoint_timeout: "15min"
  max_wal_size: "4GB"
  min_wal_size: "1GB"
  
  # Configura√ß√µes de Consultas
  random_page_cost: 1.1  # Para SSD
  effective_io_concurrency: 200  # Para SSD
  default_statistics_target: 100
  
  # Configura√ß√µes de Autovacuum
  autovacuum: true
  autovacuum_max_workers: 3
  autovacuum_naptime: "1min"
  autovacuum_vacuum_threshold: 50
  autovacuum_analyze_threshold: 50
  autovacuum_vacuum_scale_factor: 0.2
  autovacuum_analyze_scale_factor: 0.1

# =============================================================================
# üîí CONFIGURA√á√ïES DE SEGURAN√áA
# =============================================================================

security:
  # Autentica√ß√£o
  authentication_method: "scram-sha-256"  # Mais seguro que md5
  password_encryption: "scram-sha-256"
  ssl: true
  ssl_ciphers: "HIGH:!aNULL:!MD5"
  
  # Controle de Acesso
  listen_addresses: "localhost"  # Restringir acesso
  max_connections: 200
  superuser_reserved_connections: 3
  
  # Logs de Seguran√ßa
  log_connections: true
  log_disconnections: true
  log_statement: "all"  # ou "ddl", "mod", "none"
  log_duration: true
  log_line_prefix: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
  
  # Row Level Security
  row_level_security: true
  force_row_level_security: true

# =============================================================================
# üìä CONFIGURA√á√ïES DE MONITORAMENTO
# =============================================================================

monitoring:
  # Extens√µes de Monitoramento
  extensions:
    - "pg_stat_statements"  # Estat√≠sticas de consultas
    - "pg_stat_monitor"     # Monitoramento avan√ßado
    - "auto_explain"        # Explica√ß√£o autom√°tica
    - "pg_repack"           # Reorganiza√ß√£o de tabelas
    
  # Configura√ß√µes de Log
  logging_collector: true
  log_directory: "/var/log/postgresql"
  log_filename: "postgresql-%Y-%m-%d_%H%M%S.log"
  log_rotation_age: "1d"
  log_rotation_size: "100MB"
  log_min_duration_statement: 1000  # Log consultas > 1s
  
  # M√©tricas
  track_activities: true
  track_counts: true
  track_io_timing: true
  track_functions: "all"

# =============================================================================
# üîÑ CONFIGURA√á√ïES DE REPLICA√á√ÉO
# =============================================================================

replication:
  # Configura√ß√£o Prim√°ria
  primary:
    wal_level: "replica"
    max_wal_senders: 10
    max_replication_slots: 10
    hot_standby: true
    
  # Configura√ß√£o de R√©plica
  replica:
    hot_standby: true
    max_standby_archive_delay: "30s"
    max_standby_streaming_delay: "30s"
    wal_receiver_status_interval: "10s"
    
  # Configura√ß√£o de Streaming
  streaming:
    synchronous_commit: "on"  # ou "off", "local", "remote_write"
    synchronous_standby_names: "FIRST 1 (replica1, replica2)"
    wal_sync_method: "fdatasync"

# =============================================================================
# üóÇÔ∏è CONFIGURA√á√ïES DE TABELAS E √çNDICES
# =============================================================================

tables:
  # Configura√ß√µes Globais
  default_tablespace: "pg_default"
  temp_tablespaces: "pg_temp"
  
  # Configura√ß√µes de Tabelas
  fillfactor: 90  # Para tabelas com muitas atualiza√ß√µes
  autovacuum_vacuum_scale_factor: 0.2
  autovacuum_analyze_scale_factor: 0.1
  
  # Configura√ß√µes de √çndices
  index_fillfactor: 90
  maintenance_work_mem: "512MB"
  
  # Particionamento
  partitioning:
    enabled: true
    strategy: "range"  # ou "list", "hash"
    partition_key: "created_at"

# =============================================================================
# üîÑ CONFIGURA√á√ïES DE BACKUP
# =============================================================================

backup:
  # Backup Completo
  full_backup:
    enabled: true
    schedule: "0 2 * * *"  # Di√°rio √†s 2h
    retention: "30d"
    compression: "gzip"
    parallel_jobs: 4
    
  # Backup Incremental
  incremental_backup:
    enabled: true
    schedule: "0 */6 * * *"  # A cada 6 horas
    retention: "7d"
    
  # WAL Archiving
  wal_archiving:
    enabled: true
    archive_command: "gzip < %p > /var/lib/postgresql/wal_archive/%f.gz"
    archive_timeout: "1min"
    archive_mode: "on"
    
  # Point-in-Time Recovery
  pitr:
    enabled: true
    recovery_target_time: "latest"
    recovery_target_action: "promote"

# =============================================================================
# üîß CONFIGURA√á√ïES DE MANUTEN√á√ÉO
# =============================================================================

maintenance:
  # Vacuum
  vacuum:
    enabled: true
    schedule: "0 3 * * 0"  # Semanal aos domingos √†s 3h
    full_vacuum: true
    analyze: true
    
  # Reindex
  reindex:
    enabled: true
    schedule: "0 4 * * 0"  # Semanal aos domingos √†s 4h
    concurrent: true
    
  # Statistics
  statistics:
    enabled: true
    schedule: "0 1 * * *"  # Di√°rio √†s 1h
    sample_rate: 0.1

# =============================================================================
# üö® CONFIGURA√á√ïES DE ALERTAS
# =============================================================================

alerts:
  # M√©tricas Cr√≠ticas
  critical_metrics:
    connection_count:
      threshold: 180  # 90% de max_connections
      action: "alert"
      
    disk_usage:
      threshold: 85  # 85% de uso do disco
      action: "alert"
      
    replication_lag:
      threshold: "30s"  # 30 segundos de lag
      action: "alert"
      
    query_duration:
      threshold: "10s"  # Consultas > 10s
      action: "alert"
      
  # Alertas de Performance
  performance_alerts:
    slow_queries: true
    connection_spikes: true
    disk_io_high: true
    memory_usage_high: true
    
  # Notifica√ß√µes
  notifications:
    email: ["admin@omni-keywords-finder.com", "dba@omni-keywords-finder.com"]
    slack: "#database-alerts"
    pagerduty: "database-service"

# =============================================================================
# üîç CONFIGURA√á√ïES DE TESTE
# =============================================================================

testing:
  # Testes de Conectividade
  connectivity_tests:
    - "psql -h localhost -U omni_user -d omni_keywords_production -c 'SELECT 1;'"
    - "pg_isready -h localhost -p 5432"
    - "pg_ctl status -D /var/lib/postgresql/15/main"
    
  # Testes de Performance
  performance_tests:
    - "pgbench -h localhost -U omni_user -d omni_keywords_production -c 10 -t 1000"
    - "EXPLAIN ANALYZE SELECT * FROM keywords WHERE domain = 'test.com';"
    
  # Testes de Backup
  backup_tests:
    - "pg_dump -h localhost -U omni_user -d omni_keywords_production -f test_backup.sql"
    - "pg_restore -h localhost -U omni_user -d test_restore test_backup.sql"

# =============================================================================
# üìù CONFIGURA√á√ïES DE LOGS
# =============================================================================

logging:
  # Configura√ß√µes de Log
  log_destination: "stderr"
  logging_collector: true
  log_directory: "/var/log/postgresql"
  log_filename: "postgresql-%Y-%m-%d_%H%M%S.log"
  log_rotation_age: "1d"
  log_rotation_size: "100MB"
  
  # N√≠veis de Log
  log_min_messages: "warning"
  log_min_error_statement: "error"
  log_min_duration_statement: 1000
  
  # Logs Espec√≠ficos
  log_checkpoints: true
  log_connections: true
  log_disconnections: true
  log_lock_waits: true
  log_temp_files: "0"
  log_autovacuum_min_duration: "0"

# =============================================================================
# üéØ CONFIGURA√á√ïES ESPEC√çFICAS DO SISTEMA
# =============================================================================

system_specific:
  # Configura√ß√µes para Keywords Finder
  keywords_finder:
    # Tabelas principais
    keywords_table:
      name: "keywords"
      partitioning: true
      partition_key: "created_at"
      retention: "2y"
      
    analysis_table:
      name: "keyword_analysis"
      partitioning: true
      partition_key: "analysis_date"
      retention: "1y"
      
    blog_data_table:
      name: "blog_data"
      partitioning: true
      partition_key: "scraped_date"
      retention: "6m"
      
  # Configura√ß√µes de Cache
  cache:
    redis_integration: true
    query_cache: true
    cache_ttl: 3600  # 1 hora
    
  # Configura√ß√µes de Processamento
  processing:
    batch_size: 1000
    max_concurrent_queries: 10
    query_timeout: "5min"

# =============================================================================
# üìã CHECKLIST DE VALIDA√á√ÉO POSTGRESQL
# =============================================================================

validation_checklist:
  - "‚úÖ PostgreSQL 15+ instalado e configurado"
  - "‚úÖ SSL/TLS habilitado e configurado"
  - "‚úÖ Autentica√ß√£o SCRAM-SHA-256 configurada"
  - "‚úÖ Row Level Security habilitado"
  - "‚úÖ Extens√µes de monitoramento instaladas"
  - "‚úÖ Backup autom√°tico configurado"
  - "‚úÖ Replica√ß√£o configurada (se aplic√°vel)"
  - "‚úÖ Autovacuum configurado e otimizado"
  - "‚úÖ Logs configurados e centralizados"
  - "‚úÖ Alertas configurados"
  - "‚úÖ Performance otimizada para carga esperada"
  - "‚úÖ Seguran√ßa configurada (firewall, acesso restrito)"
  - "‚úÖ Monitoramento ativo"
  - "‚úÖ Procedimentos de recupera√ß√£o testados"
  - "‚úÖ Documenta√ß√£o atualizada"

# =============================================================================
# ‚ö†Ô∏è AVISOS IMPORTANTES
# =============================================================================

warnings:
  - "Manter PostgreSQL sempre atualizado com patches de seguran√ßa"
  - "Monitorar logs regularmente para detectar problemas"
  - "Fazer backup antes de qualquer altera√ß√£o cr√≠tica"
  - "Testar configura√ß√µes em ambiente de staging"
  - "Documentar todas as altera√ß√µes de configura√ß√£o"
  - "Manter estat√≠sticas atualizadas para otimiza√ß√£o"
  - "Configurar alertas para m√©tricas cr√≠ticas"
  - "Implementar rota√ß√£o de logs"
  - "Treinar equipe em administra√ß√£o PostgreSQL"
  - "Auditar configura√ß√µes de seguran√ßa regularmente" 