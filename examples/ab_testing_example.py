"""
Exemplo Pr√°tico de A/B Testing
==============================

Este exemplo demonstra como usar o sistema completo de A/B Testing:
- Cria√ß√£o de experimentos
- Atribui√ß√£o de usu√°rios
- Tracking de convers√µes
- An√°lise estat√≠stica
- Gera√ß√£o de relat√≥rios

Author: Paulo J√∫nior
Date: 2024-12-19
Tracing ID: AB_TESTING_EXAMPLE_001
"""

import time
import random
import json
from datetime import datetime, timedelta
from typing import Dict, List, Any

from infrastructure.ab_testing.framework import ABTestingFramework
from infrastructure.ab_testing.experiment_manager import ExperimentManager
from infrastructure.ab_testing.analytics import ABTestingAnalytics


class ABTestingExample:
    """
    Exemplo completo de uso do sistema de A/B Testing
    
    Demonstra:
    - Cria√ß√£o e configura√ß√£o de experimentos
    - Simula√ß√£o de tr√°fego de usu√°rios
    - Tracking de convers√µes
    - An√°lise estat√≠stica em tempo real
    - Gera√ß√£o de relat√≥rios
    """
    
    def __init__(self):
        """Inicializa o exemplo"""
        # Framework principal
        self.framework = ABTestingFramework(
            redis_config=None,  # Sem Redis para simplicidade
            enable_observability=False
        )
        
        # Gerenciador de experimentos
        self.manager = ExperimentManager(
            framework=self.framework,
            enable_monitoring=True,
            enable_alerts=True
        )
        
        # Analytics
        self.analytics = ABTestingAnalytics(
            framework=self.framework,
            enable_visualization=False,
            enable_observability=False
        )
        
        # Dados simulados
        self.simulated_users = []
        self.conversion_events = []
        
        print("üöÄ Sistema de A/B Testing inicializado")
    
    def create_button_color_experiment(self) -> str:
        """Cria experimento de teste de cor de bot√£o"""
        print("\nüìä Criando experimento: Teste de Cor de Bot√£o")
        
        experiment_id = self.manager.create_experiment_with_template(
            template_name="button_color",
            name="Teste de Cor de Bot√£o - Landing Page",
            description="Testa diferentes cores de bot√£o CTA para maximizar convers√µes",
            custom_config={
                "traffic_allocation": 0.15,  # 15% do tr√°fego
                "min_sample_size": 200,
                "tags": ["landing_page", "conversion", "ui"]
            }
        )
        
        print(f"‚úÖ Experimento criado: {experiment_id}")
        return experiment_id
    
    def create_headline_experiment(self) -> str:
        """Cria experimento de teste de headline"""
        print("\nüìä Criando experimento: Teste de Headline")
        
        experiment_id = self.manager.create_experiment_with_template(
            template_name="headline_test",
            name="Teste de Headline - P√°gina Principal",
            description="Testa diferentes headlines para aumentar engajamento",
            custom_config={
                "traffic_allocation": 0.10,  # 10% do tr√°fego
                "min_sample_size": 300,
                "tags": ["content", "engagement", "seo"]
            }
        )
        
        print(f"‚úÖ Experimento criado: {experiment_id}")
        return experiment_id
    
    def create_pricing_experiment(self) -> str:
        """Cria experimento de teste de pre√ßos"""
        print("\nüìä Criando experimento: Teste de Pre√ßos")
        
        experiment_id = self.manager.create_experiment_with_template(
            template_name="pricing_test",
            name="Teste de Estrat√©gia de Pre√ßos",
            description="Testa diferentes estrat√©gias de pre√ßos para maximizar receita",
            custom_config={
                "traffic_allocation": 0.05,  # 5% do tr√°fego (pre√ßos s√£o sens√≠veis)
                "min_sample_size": 500,
                "tags": ["pricing", "revenue", "business"]
            }
        )
        
        print(f"‚úÖ Experimento criado: {experiment_id}")
        return experiment_id
    
    def activate_experiments(self, experiment_ids: List[str]):
        """Ativa todos os experimentos"""
        print("\nüéØ Ativando experimentos...")
        
        for experiment_id in experiment_ids:
            try:
                self.framework.activate_experiment(experiment_id)
                print(f"‚úÖ Experimento {experiment_id} ativado")
            except Exception as e:
                print(f"‚ùå Erro ao ativar {experiment_id}: {e}")
    
    def simulate_user_traffic(self, 
                            experiment_ids: List[str], 
                            num_users: int = 1000,
                            duration_minutes: int = 30):
        """Simula tr√°fego de usu√°rios"""
        print(f"\nüë• Simulando {num_users} usu√°rios por {duration_minutes} minutos...")
        
        start_time = datetime.utcnow()
        end_time = start_time + timedelta(minutes=duration_minutes)
        
        user_count = 0
        conversion_count = 0
        
        while datetime.utcnow() < end_time and user_count < num_users:
            # Simular chegada de usu√°rio
            user_id = f"user_{user_count:06d}"
            session_id = f"session_{user_count:06d}"
            
            # Atribuir usu√°rio a experimentos
            for experiment_id in experiment_ids:
                variant = self.framework.assign_user_to_variant(
                    user_id=user_id,
                    experiment_id=experiment_id,
                    session_id=session_id,
                    user_attributes={
                        "country": random.choice(["BR", "US", "CA", "UK"]),
                        "device": random.choice(["desktop", "mobile", "tablet"]),
                        "user_type": random.choice(["new", "returning"])
                    }
                )
                
                if variant:
                    # Simular convers√£o baseada na variante
                    conversion_probability = self._get_conversion_probability(variant, experiment_id)
                    
                    if random.random() < conversion_probability:
                        # Registrar convers√£o
                        self.framework.track_conversion(
                            user_id=user_id,
                            experiment_id=experiment_id,
                            metric_name="conversion_rate",
                            value=1.0,
                            metadata={
                                "session_id": session_id,
                                "timestamp": datetime.utcnow().isoformat(),
                                "user_attributes": {
                                    "country": random.choice(["BR", "US", "CA", "UK"]),
                                    "device": random.choice(["desktop", "mobile", "tablet"])
                                }
                            }
                        )
                        conversion_count += 1
                        
                        # Simular m√©tricas adicionais
                        self._simulate_additional_metrics(user_id, experiment_id, variant)
            
            user_count += 1
            
            # Pausa para simular tempo real
            time.sleep(0.1)
            
            # Progresso a cada 100 usu√°rios
            if user_count % 100 == 0:
                elapsed = (datetime.utcnow() - start_time).total_seconds()
                rate = user_count / elapsed if elapsed > 0 else 0
                print(f"üìà Progresso: {user_count}/{num_users} usu√°rios ({rate:.1f} usu√°rios/seg)")
        
        print(f"‚úÖ Simula√ß√£o conclu√≠da: {user_count} usu√°rios, {conversion_count} convers√µes")
        return user_count, conversion_count
    
    def _get_conversion_probability(self, variant: str, experiment_id: str) -> float:
        """Retorna probabilidade de convers√£o baseada na variante"""
        experiment = self.framework.experiments[experiment_id]
        
        # Probabilidades baseadas no tipo de experimento
        if "button_color" in experiment.tags:
            if variant == "control":
                return 0.05  # 5% baseline
            elif variant == "green":
                return 0.06  # 6% - 20% melhor
            elif variant == "red":
                return 0.04  # 4% - 20% pior
        
        elif "headline_test" in experiment.tags:
            if variant == "control":
                return 0.08  # 8% baseline
            elif variant == "benefit":
                return 0.10  # 10% - 25% melhor
            elif variant == "urgency":
                return 0.09  # 9% - 12.5% melhor
        
        elif "pricing_test" in experiment.tags:
            if variant == "control":
                return 0.03  # 3% baseline
            elif variant == "higher":
                return 0.02  # 2% - 33% pior
            elif variant == "lower":
                return 0.04  # 4% - 33% melhor
        
        return 0.05  # Probabilidade padr√£o
    
    def _simulate_additional_metrics(self, user_id: str, experiment_id: str, variant: str):
        """Simula m√©tricas adicionais"""
        # Simular tempo na p√°gina
        time_on_page = random.uniform(30, 300)  # 30s a 5min
        self.framework.track_conversion(
            user_id=user_id,
            experiment_id=experiment_id,
            metric_name="time_on_page",
            value=time_on_page
        )
        
        # Simular receita (apenas para alguns usu√°rios)
        if random.random() < 0.1:  # 10% dos usu√°rios geram receita
            revenue = random.uniform(10, 100)
            self.framework.track_conversion(
                user_id=user_id,
                experiment_id=experiment_id,
                metric_name="revenue",
                value=revenue
            )
        
        # Simular taxa de rejei√ß√£o
        if random.random() < 0.3:  # 30% dos usu√°rios rejeitam
            self.framework.track_conversion(
                user_id=user_id,
                experiment_id=experiment_id,
                metric_name="bounce_rate",
                value=1.0
            )
    
    def analyze_experiments(self, experiment_ids: List[str]):
        """Analisa todos os experimentos"""
        print("\nüìä Analisando experimentos...")
        
        for experiment_id in experiment_ids:
            try:
                print(f"\nüîç Analisando experimento: {experiment_id}")
                
                # Obter resumo do experimento
                summary = self.framework.get_experiment_summary(experiment_id)
                print(f"   Nome: {summary['name']}")
                print(f"   Status: {summary['status']}")
                print(f"   Usu√°rios: {summary['variant_counts']}")
                
                # An√°lise estat√≠stica
                analysis = self.analytics.analyze_experiment_statistical(experiment_id)
                
                if "error" in analysis:
                    print(f"   ‚ùå Erro na an√°lise: {analysis['error']}")
                    continue
                
                # Mostrar resultados por variante
                print("   üìà Resultados por variante:")
                for variant, data in analysis["variant_analyses"].items():
                    print(f"     {variant}:")
                    print(f"       Amostra: {data['sample_size']} usu√°rios")
                    print(f"       Taxa de convers√£o: {data['conversion_rate']:.3f}")
                    print(f"       M√©dia: {data['mean_value']:.3f}")
                    print(f"       Intervalo de confian√ßa: [{data['confidence_interval'][0]:.3f}, {data['confidence_interval'][1]:.3f}]")
                
                # Mostrar resultados estat√≠sticos
                print("   üßÆ An√°lise estat√≠stica:")
                for variant, stats in analysis["statistical_results"].items():
                    print(f"     {variant} vs control:")
                    print(f"       P-value: {stats['p_value']:.4f}")
                    print(f"       Significativo: {'‚úÖ' if stats['is_significant'] else '‚ùå'}")
                    print(f"       Lift: {stats['lift']:.1f}%")
                    print(f"       Poder estat√≠stico: {stats['power']:.2f}")
                
                # An√°lise geral
                overall = analysis["overall_analysis"]
                print(f"   üìä An√°lise geral:")
                print(f"     Total de usu√°rios: {overall['total_users']}")
                print(f"     Melhor variante: {overall['best_variant']}")
                print(f"     Melhor lift: {overall['best_lift']:.1f}%")
                print(f"     Variantes significativas: {overall['significant_variants']}")
                print(f"     Recomenda√ß√£o: {overall['recommendation']}")
                
            except Exception as e:
                print(f"   ‚ùå Erro ao analisar {experiment_id}: {e}")
    
    def generate_reports(self, experiment_ids: List[str]):
        """Gera relat√≥rios completos"""
        print("\nüìã Gerando relat√≥rios...")
        
        for experiment_id in experiment_ids:
            try:
                print(f"\nüìÑ Gerando relat√≥rio para: {experiment_id}")
                
                # Relat√≥rio do gerenciador
                manager_report = self.manager.generate_experiment_report(experiment_id)
                
                # Relat√≥rio do analytics
                analytics_report = self.analytics.generate_report(experiment_id)
                
                # Salvar relat√≥rios
                self._save_report(experiment_id, manager_report, "manager")
                self._save_report(experiment_id, analytics_report, "analytics")
                
                print(f"   ‚úÖ Relat√≥rios salvos para {experiment_id}")
                
            except Exception as e:
                print(f"   ‚ùå Erro ao gerar relat√≥rio para {experiment_id}: {e}")
    
    def _save_report(self, experiment_id: str, report: Dict[str, Any], report_type: str):
        """Salva relat√≥rio em arquivo"""
        filename = f"reports/{experiment_id}_{report_type}_report.json"
        
        # Criar diret√≥rio se n√£o existir
        import os
        os.makedirs("reports", exist_ok=True)
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False, default=str)
    
    def show_experiment_health(self, experiment_ids: List[str]):
        """Mostra sa√∫de dos experimentos"""
        print("\nüè• Verificando sa√∫de dos experimentos...")
        
        for experiment_id in experiment_ids:
            try:
                health = self.manager.get_experiment_health(experiment_id)
                
                print(f"\nüîç Sa√∫de do experimento: {experiment_id}")
                print(f"   Score: {health['health_score']}/100")
                print(f"   Status: {health['status']}")
                print(f"   Usu√°rios: {health['total_users']}/{health['min_sample_size']}")
                print(f"   Distribui√ß√£o: {health['variant_distribution']}")
                
                if health['recommendations']:
                    print("   üí° Recomenda√ß√µes:")
                    for rec in health['recommendations']:
                        print(f"     - {rec}")
                
            except Exception as e:
                print(f"   ‚ùå Erro ao verificar sa√∫de de {experiment_id}: {e}")
    
    def run_complete_example(self):
        """Executa exemplo completo"""
        print("üéØ EXEMPLO COMPLETO DE A/B TESTING")
        print("=" * 50)
        
        # 1. Criar experimentos
        experiment_ids = []
        experiment_ids.append(self.create_button_color_experiment())
        experiment_ids.append(self.create_headline_experiment())
        experiment_ids.append(self.create_pricing_experiment())
        
        # 2. Ativar experimentos
        self.activate_experiments(experiment_ids)
        
        # 3. Simular tr√°fego
        print("\n" + "=" * 50)
        print("üö¶ SIMULA√á√ÉO DE TR√ÅFEGO")
        print("=" * 50)
        
        users, conversions = self.simulate_user_traffic(
            experiment_ids=experiment_ids,
            num_users=500,  # 500 usu√°rios
            duration_minutes=5  # 5 minutos
        )
        
        # 4. Verificar sa√∫de
        print("\n" + "=" * 50)
        print("üè• VERIFICA√á√ÉO DE SA√öDE")
        print("=" * 50)
        
        self.show_experiment_health(experiment_ids)
        
        # 5. Analisar experimentos
        print("\n" + "=" * 50)
        print("üìä AN√ÅLISE ESTAT√çSTICA")
        print("=" * 50)
        
        self.analyze_experiments(experiment_ids)
        
        # 6. Gerar relat√≥rios
        print("\n" + "=" * 50)
        print("üìã GERA√á√ÉO DE RELAT√ìRIOS")
        print("=" * 50)
        
        self.generate_reports(experiment_ids)
        
        # 7. Resumo final
        print("\n" + "=" * 50)
        print("üéâ RESUMO FINAL")
        print("=" * 50)
        
        print(f"‚úÖ Experimentos criados: {len(experiment_ids)}")
        print(f"üë• Usu√°rios simulados: {users}")
        print(f"üí∞ Convers√µes registradas: {conversions}")
        print(f"üìà Taxa de convers√£o geral: {conversions/users*100:.2f}%")
        
        print("\nüìÅ Relat√≥rios salvos em: reports/")
        print("üîç Verifique os arquivos JSON para an√°lise detalhada")
        
        return {
            "experiments": experiment_ids,
            "users": users,
            "conversions": conversions,
            "conversion_rate": conversions/users if users > 0 else 0
        }


def main():
    """Fun√ß√£o principal"""
    print("üöÄ Iniciando exemplo de A/B Testing...")
    
    # Criar e executar exemplo
    example = ABTestingExample()
    results = example.run_complete_example()
    
    print(f"\nüéØ Exemplo conclu√≠do com sucesso!")
    print(f"üìä Resultados: {results}")


if __name__ == "__main__":
    main() 